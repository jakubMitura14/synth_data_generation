#adapted from https://github.com/JuliaGPU/julia-ngc
# ARG IMAGE=nvidia/cuda:12.1.1-devel-ubuntu20.04
# FROM nvidia/cudagl:11.3.0-devel
# FROM nvidia/cuda:11.2.2-cudnn8-devel-ubuntu20.04
# FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04
# FROM nvidia/cuda:12.1.1-devel-ubuntu20.04
# FROM nvidia/cuda:12.1.1-devel-ubuntu20.04

# ARG JULIA_RELEASE=1.10
# ARG JULIA_VERSION=1.10.0

FROM nvcr.io/nvidia/jax:24.10-maxtext-py3


ARG JULIA_RELEASE=1.10
ARG JULIA_VERSION=1.10.4
# ARG JULIA_VERSION=1.9.0-rc3

ENV DEBIAN_FRONTEND=noninteractive

# julia

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive \
    apt-get install --yes --no-install-recommends \
    # basic stuff
    curl ca-certificates nano && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN curl -s -L https://julialang-s3.julialang.org/bin/linux/x64/${JULIA_RELEASE}/julia-${JULIA_VERSION}-linux-x86_64.tar.gz | \
    tar -C /usr/local -x -z --strip-components=1 -f -



RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && \
    apt install -y python3.10 && \
    apt-get install -y  python3.10-dev

RUN curl -fSsL -O https://bootstrap.pypa.io/get-pip.py && \
    python3.10 get-pip.py && \
    rm get-pip.py



RUN apt-get update -q -y && \
    DEBIAN_FRONTEND=noninteractive \
    apt-get install -q -y --allow-change-held-packages\
    vim net-tools curl \
    # libgl1-mesa-glx \
    # xserver-xorg-video-dummy \
    # libxrender1 \
    # libpulse0 \
    # libpulse-mainloop-glib0  \
    # libnss3  \
    # libxcomposite1 \
    # libxcursor1 \
    # libfontconfig1 \
    # libxrandr2 \
    # libasound2 \
    # libglu1 \
    # x11vnc \
    # awesome \
    # jq \
    # nautilus\
    # jupyter-core\
    # zip\
    # p7zip-full\
    # apt-utils\
    # octave\
    # kmod\
    # zlib1g\
    # # python-dev\
    # bzip2\
    cmake\
    # cuda-command-line-tools-12.1 \
    # libcublas-12.1 \
    # cuda-nvrtc-12.1\
    # libcufft-12.1 \
    # libcurand-12.1 \
    # libcusolver-12.1 \
    # libcusparse-12.1 \
    # libfreetype6-dev \
    # curl\
    # libzmq3-dev \
    # software-properties-common\
    # libhdf5-serial-dev\
    git \
    # at-spi2-core \
    # libgtk-3-dev \
    # # xauth \
    # xvfb \
    ninja-build \
    python3 \
    python3-pip \
    python3-setuptools \
    python3-wheel \
    ninja-build \
    wget \
    # doxygen \
    # autoconf \
    # automake \
    cmake \
    g++ \
    gcc \
    make \
    # nasm \
    # xxd \
    # yasm \
    # libglfw3 \
    # libglfw3-dev \
    # freeglut3-dev \
    # make \
    # pkgconf \
    # xz-utils \
    # xorg-dev \
    # libgl1-mesa-dev \
    # libglu1-mesa-dev \
    # libxrandr-dev \
    # libxinerama-dev \
    # libxcursor-dev \
    # libxi-dev \
    # libxxf86vm-dev \
    libglfw3 libglfw3-dev xorg-dev libxkbcommon-dev meson git cmake libssl-dev cmake \
    ffmpeg && \
    apt-get install -q -y --reinstall ca-certificates

RUN apt-get update && \
apt-get remove --purge -y 'libcudnn*' && \
apt-get autoremove -y
# RUN python3 -m pip  --no-cache-dir install install --no-cache-dir monai

RUN apt-get install --yes --no-install-recommends wget build-essential libcurl4 && \
    wget https://curl.se/download/curl-7.81.0.tar.gz && \
    tar -xvf curl-7.81.0.tar.gz && cd curl-7.81.0 && \
    ./configure --with-openssl && make && make install


# COPY Project.toml Manifest.toml LocalPreferences.toml /usr/local/share/julia/environments/v${JULIA_RELEASE}/

# RUN JULIA_DEPOT_PATH=/usr/local/share/julia \ 
#     julia -e 'using Pkg; Pkg.Registry.update(); Pkg.instantiate(); Pkg.API.precompile()'

# # generate the device runtime library for all known and supported devices
# # XXX: this doesn't precompile into the system depot anymore
# RUN JULIA_DEPOT_PATH=/usr/local/share/julia \ 
#     julia -e 'using CUDA; CUDA.precompile_runtime()'

# the system depot contains precompiled packages, but its global environment cannot be
# active at the same time of the user environment. we solve this by using a startup script
# that will initialize the user depot with the Project and Manifest from the system depot.
# however, for that script to run, we need to start with only the system depot active.
ENV JULIA_DEPOT_PATH=/usr/local/share/julia
COPY startup.jl /usr/local/share/julia/config/
# RUN julia -e 'using Pkg ;ENV["MODERNGL_DEBUGGING"] = "true"; Pkg.build("ModernGL")'






# user environment

# we use a single folder, /data, as the user depot regardless of the actual user
# (i.e., to be compatible with `docker run --user`, which might not have a $HOME)

RUN mkdir -m 0777 /data
RUN mkdir $HOME/data

ENV JULIA_HISTORY=/data/logs/repl_history.jl
#TODO set up dynamically after start
ENV LD_LIBRARY_PATH=""
# RUN mkdir $HOME/data_decathlon &&\
# cd $HOME/data_decathlon &&\
# wget https://raw.githubusercontent.com/pavanjadhaw/gdown.pl/master/gdown.pl && chmod u+x gdown.pl &&\
# ./gdown https://drive.google.com/file/d/1jyVGUGyxKBXV6_9ivuZapQS8eUJXCIpu/view?usp=sharing

COPY download_data.py /workspace/download_data.py

RUN python3 /workspace/download_data.py


# setup enviromental variables for Julia multithreading keeping one interactive thread
COPY setup_threads.sh  /etc/profile.d/

# COPY initt.jl $HOME/initt.jl
# RUN chmod +x $HOME/initt.jl


RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    libglvnd-dev libglvnd-dev \
    libgl1-mesa-dev libgl1-mesa-dev \
    libegl1-mesa-dev libegl1-mesa-dev \
    libgles2-mesa-dev libgles2-mesa-dev && \
    rm -rf /var/lib/apt/lists/*


# ENV cudnn_version=8.1
# ENV cuda_version=12.1
# RUN apt-get install libcudnn8
# RUN apt-get install libcudnn8-dev
# RUN apt-get install libcudnn8-samples
# RUN apt-get install libcudnn8=${cudnn_version}-1+${cuda_version}
# RUN apt-get install libcudnn8-dev=${cudnn_version}-1+${cuda_version}
# RUN apt-get install libcudnn8-samples=${cudnn_version}-1+${cuda_version}

RUN curl -sSL https://sdk.cloud.google.com | bash

RUN julia -e 'using Pkg; Pkg.add(url="https://github.com/jakubMitura14/ImagePhantoms.jl.git")'
RUN julia -e 'using Pkg; Pkg.add(["UUIDs","JSON","HDF5","ImagePhantoms","MIRTjim","ImageGeoms","Sinograms", "PyCall", "FFTW", "LazyGrids", "Unitful", "Plots", "Revise"])'
# RUN julia -e 'using Pkg; Pkg.add("GoogleCloud")'
# RUN julia -e 'using Pkg; Pkg.add("UUIDs")'

ENV PATH $PATH:/root/google-cloud-sdk/bin
COPY infostrateg-b-f395071711c1.json /root/.devcontainer/infostrateg-b-f395071711c1.json
ENV GOOGLE_APPLICATION_CREDENTIALS="/root/.devcontainer/infostrateg-b-f395071711c1.json"

RUN gcloud auth activate-service-account --key-file="/root/.devcontainer/infostrateg-b-f395071711c1.json"
#In order to make it work one need first to add service account then get to serviceaccounts -> permissions->grant access-> add service role for example metrotk@infostrateg-b.iam.gserviceaccount.com-> set role to owner
#or better navigate to ready storage servie account created automatically by goolge get there to keys and generate json https://console.cloud.google.com/iam-admin/serviceaccounts/details/102246773279033981870/keys?chat=true&inv=1&invt=AbjYqw&project=infostrateg-b

# This is secret and shouldn't be checked into version control
ENV WANDB_API_KEY=5a6c2e2caccb19a9c3cbfde388b61c7104eab632
# Name and notes optional
# WANDB_NAME="My first run"
# WANDB_NOTES="Smaller learning rate, more regularization."

# Only needed if you don't check in the wandb/settings file
# ENV WANDB_ENTITY=jakubmituraaa-opi
# ENV WANDB_PROJECT=synth_data
COPY generate-random_can_low_res.jl /root/.devcontainer/generate-random_can_low_res.jl
COPY get_geometry_main.jl /root/.devcontainer/get_geometry_main.jl
COPY CtFanArc_params.jl /root/.devcontainer/CtFanArc_params.jl

RUN python3 -m pip install SimpleITK numpy wandb

# RUN python3 -m pip install --upgrade "jax[cuda12_pip]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

RUN python3 -m pip install einops numpy pandas matplotlib scikit-image scikit-learn h5py sqlalchemy pymysql monai tensorflow optuna ml_collections
#flax optax


# CMD ["julia", "/root/.devcontainer/generate-random_can_low_res.jl"]

# WORKDIR "/workspace"
# # COPY examples /workspace/examples

# ENTRYPOINT ["/usr/local/bin/julia"]
# CMD ["sleep", "infinity"]



# /workspaces/MedEye3d.jl/.devcontainer/initt.jl


# using GoogleCloud
# import GoogleCloud
# creds = JSONCredentials(expanduser(".devcontainer/infostrateg-b-b87b7834a452.json"))
# session = GoogleSession(creds, ["devstorage.full_control"])
# set_session!(storage, session) 
# bkts = storage(:Bucket, :list)    # storage(:Bucket, :list; raw=true) returns addition information

# # Pretty print
# for item in bkts
#     display(item)
#     println()
# end

# .devcontainer/infostrateg-b-b87b7834a452.json

# metrotk@infostrateg-b.iam.gserviceaccount.com
# bucket_metro_tk


#gcloud auth activate-service-account --key-file="/workspaces/synthethic_tomo/data/infostrateg-b-b87b7834a452.json"
# gcloud storage cp /workspaces/synthethic_tomo/.devcontainer/oldDockerfileOld.txt gs://bucket_metro_tk/aa.txt

#cuda 12.6 cudnn 9.5